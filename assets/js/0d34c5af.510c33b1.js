"use strict";(self.webpackChunkfig_documentation=self.webpackChunkfig_documentation||[]).push([[3491],{3358:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"features/client-secrets/google-secret-provider","title":"Fig Google Cloud Secret Provider","description":"This integration has not been well tested and may contain bugs. Please report any bugs to the GitHub repo","source":"@site/docs/features/28-client-secrets/6-google-secret-provider.md","sourceDirName":"features/28-client-secrets","slug":"/features/client-secrets/google-secret-provider","permalink":"/docs/next/features/client-secrets/google-secret-provider","draft":false,"unlisted":false,"editUrl":"https://github.com/mzbrau/fig/tree/main/doc/fig-documentation/docs/features/28-client-secrets/6-google-secret-provider.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6,"sidebar_label":"Google Cloud Client Secret Provider"},"sidebar":"tutorialSidebar","previous":{"title":"AWS Client Secret Provider","permalink":"/docs/next/features/client-secrets/aws-secret-provider"},"next":{"title":"Metadata Properties","permalink":"/docs/next/features/metadata-properties"}}');var s=i(4848),o=i(8453);const t={sidebar_position:6,sidebar_label:"Google Cloud Client Secret Provider"},l="Fig Google Cloud Secret Provider",c={},a=[{value:"Features",id:"features",level:2},{value:"Installation",id:"installation",level:2},{value:"Usage",id:"usage",level:2},{value:"Basic Usage with Default Credentials",id:"basic-usage-with-default-credentials",level:3},{value:"Secret Naming Convention",id:"secret-naming-convention",level:2},{value:"Authentication",id:"authentication",level:2},{value:"Required Google Cloud Permissions",id:"required-google-cloud-permissions",level:2},{value:"Minimal Custom Role",id:"minimal-custom-role",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Google Cloud Setup",id:"google-cloud-setup",level:2},{value:"Enable the Secret Manager API",id:"enable-the-secret-manager-api",level:3},{value:"Create a Service Account (if needed)",id:"create-a-service-account-if-needed",level:3},{value:"Grant Permissions",id:"grant-permissions",level:3},{value:"Thread Safety",id:"thread-safety",level:2},{value:"Integration with Fig",id:"integration-with-fig",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Enable Logging",id:"enable-logging",level:3},{value:"Verify Credentials",id:"verify-credentials",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Regional Considerations",id:"regional-considerations",level:2}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"fig-google-cloud-secret-provider",children:"Fig Google Cloud Secret Provider"})}),"\n",(0,s.jsx)(n.admonition,{title:"Experimental",type:"warning",children:(0,s.jsx)(n.p,{children:"This integration has not been well tested and may contain bugs. Please report any bugs to the GitHub repo"})}),"\n",(0,s.jsx)(n.p,{children:"This package provides Google Cloud Secret Manager integration for Fig client secret management using managed identity authentication."}),"\n",(0,s.jsx)(n.h2,{id:"features",children:"Features"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Managed Identity Support"}),": Uses Google Cloud's Application Default Credentials (service accounts, workload identity, etc.)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Automatic Secret Creation"}),": Secrets are only auto-created if the environment variable ",(0,s.jsx)(n.code,{children:"ASPNETCORE_ENVIRONMENT"})," or ",(0,s.jsx)(n.code,{children:"DOTNET_ENVIRONMENT"})," is set to ",(0,s.jsx)(n.code,{children:"Development"}),". In all other environments, secrets must already exist or a ",(0,s.jsx)(n.code,{children:"SecretNotFoundException"})," will be thrown."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Thread-Safe"}),": Safe for concurrent use across multiple threads"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Retry Logic"}),": Built-in exponential backoff for transient errors"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource Management"}),": Implements IDisposable for proper cleanup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Google Cloud Best Practices"}),": Follows recommended naming conventions and security practices"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"dotnet add package Fig.Client.SecretProvider.Google\n"})}),"\n",(0,s.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.h3,{id:"basic-usage-with-default-credentials",children:"Basic Usage with Default Credentials"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using Fig.Client.Google;\n\nbuilder.Configuration.SetBasePath(GetBasePath())\n    .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)\n    .AddFig<Settings>(options =>\n    {\n        options.ClientName = "AspNetApi";\n        options.LoggerFactory = loggerFactory;\n        options.CommandLineArgs = args;\n        options.ClientSecretProviders = [new GoogleSecretProvider("your-project-id")]\n    });\n'})}),"\n",(0,s.jsx)(n.h2,{id:"secret-naming-convention",children:"Secret Naming Convention"}),"\n",(0,s.jsxs)(n.p,{children:["Secrets are stored in Google Cloud Secret Manager using the format: ",(0,s.jsx)(n.code,{children:"FIG_{CLIENT_NAME}_SECRET"})]}),"\n",(0,s.jsxs)(n.p,{children:['For example, if your client name is "MyService", the secret will be named: ',(0,s.jsx)(n.code,{children:"FIG_MYSERVICE_SECRET"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": This follows the same naming convention as the Azure and AWS secret providers for consistency across cloud platforms."]}),"\n",(0,s.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,s.jsx)(n.p,{children:"This provider uses Google Cloud's Application Default Credentials (ADC), which checks for credentials in the following order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GOOGLE_APPLICATION_CREDENTIALS"})," environment variable pointing to a service account key file"]}),"\n",(0,s.jsxs)(n.li,{children:["Google Cloud SDK credentials (",(0,s.jsx)(n.code,{children:"gcloud auth application-default login"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"Google Cloud Shell credentials"}),"\n",(0,s.jsx)(n.li,{children:"Compute Engine service account (when running on Google Cloud)"}),"\n",(0,s.jsx)(n.li,{children:"Google Kubernetes Engine workload identity (when running on GKE)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"required-google-cloud-permissions",children:"Required Google Cloud Permissions"}),"\n",(0,s.jsx)(n.p,{children:"The service account or user must have the following IAM permissions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "bindings": [\n    {\n      "role": "roles/secretmanager.secretAccessor",\n      "members": ["serviceAccount:your-service-account@project.iam.gserviceaccount.com"]\n    },\n    {\n      "role": "roles/secretmanager.secretCreator",\n      "members": ["serviceAccount:your-service-account@project.iam.gserviceaccount.com"]\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"minimal-custom-role",children:"Minimal Custom Role"}),"\n",(0,s.jsx)(n.p,{children:"For more granular control, create a custom role with these permissions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "title": "Fig Secret Manager",\n  "description": "Minimal permissions for Fig secret provider",\n  "permissions": [\n    "secretmanager.secrets.create",\n    "secretmanager.secrets.get",\n    "secretmanager.versions.access",\n    "secretmanager.versions.add"\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"In non-development environments, secrets are never auto-created, so you only need:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"secretmanager.secrets.get"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"secretmanager.versions.access"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"The provider handles common Google Cloud errors gracefully:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"NotFound"}),": Thrown when a secret doesn't exist and the environment is not ",(0,s.jsx)(n.code,{children:"Development"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Transient Errors"}),": Automatically retried with exponential backoff (rate limiting, service unavailable, etc.)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Concurrent Creation"}),": Handles race conditions when multiple instances try to create the same secret"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use Workload Identity"}),": When running on Google Kubernetes Engine, use workload identity"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Service Accounts"}),": Use dedicated service accounts with minimal permissions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Least Privilege"}),": Grant only the minimum required permissions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Resource Cleanup"}),": Dispose the provider when your application shuts down"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Error Monitoring"}),": Log and monitor for authentication and permission errors"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Secret Rotation"}),": Consider implementing secret rotation policies"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"No AutoCreate in Production"}),": In production and all non-development environments, secrets will not be auto-created."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"google-cloud-setup",children:"Google Cloud Setup"}),"\n",(0,s.jsx)(n.h3,{id:"enable-the-secret-manager-api",children:"Enable the Secret Manager API"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"gcloud services enable secretmanager.googleapis.com\n"})}),"\n",(0,s.jsx)(n.h3,{id:"create-a-service-account-if-needed",children:"Create a Service Account (if needed)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'gcloud iam service-accounts create fig-secret-manager \\\n    --display-name="Fig Secret Manager" \\\n    --description="Service account for Fig secret management"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"grant-permissions",children:"Grant Permissions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\\n    --member="serviceAccount:fig-secret-manager@YOUR_PROJECT_ID.iam.gserviceaccount.com" \\\n    --role="roles/secretmanager.secretAccessor"\n\ngcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\\n    --member="serviceAccount:fig-secret-manager@YOUR_PROJECT_ID.iam.gserviceaccount.com" \\\n    --role="roles/secretmanager.secretCreator"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"thread-safety",children:"Thread Safety"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"GoogleSecretProvider"})," is thread-safe and uses a semaphore to prevent race conditions during secret creation. Multiple threads can safely call ",(0,s.jsx)(n.code,{children:"GetSecret()"})," concurrently."]}),"\n",(0,s.jsx)(n.h2,{id:"integration-with-fig",children:"Integration with Fig"}),"\n",(0,s.jsxs)(n.p,{children:["This provider implements the ",(0,s.jsx)(n.code,{children:"IClientSecretProvider"})," interface and can be used with any Fig configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'var secretProvider = new GoogleSecretProvider("your-project-id");\n\nvar config = FigConfigurationBuilder.Start<MySettings>()\n    .WithClientSecretProvider(secretProvider)\n    .WithApiUris("https://your-fig-api.com")\n    .Build();\n'})}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Permission Denied"}),": Ensure your service account has the required permissions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Project Not Found"}),": Verify the project ID is correct and accessible"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"API Not Enabled"}),": Enable the Secret Manager API in your Google Cloud project"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authentication Failed"}),": Check your Application Default Credentials setup"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"enable-logging",children:"Enable Logging"}),"\n",(0,s.jsx)(n.p,{children:"Enable Google Cloud client library logging for troubleshooting:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'// In your startup code\nEnvironment.SetEnvironmentVariable("GRPC_VERBOSITY", "DEBUG");\nEnvironment.SetEnvironmentVariable("GRPC_TRACE", "all");\n'})}),"\n",(0,s.jsx)(n.h3,{id:"verify-credentials",children:"Verify Credentials"}),"\n",(0,s.jsx)(n.p,{children:"Test your credentials using the Google Cloud SDK:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"gcloud auth application-default print-access-token\n"})}),"\n",(0,s.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GOOGLE_APPLICATION_CREDENTIALS"}),": Path to service account key file"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GOOGLE_CLOUD_PROJECT"}),": Default project ID (optional)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GRPC_VERBOSITY"}),": Set to ",(0,s.jsx)(n.code,{children:"DEBUG"})," for verbose logging"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GRPC_TRACE"}),": Set to ",(0,s.jsx)(n.code,{children:"all"})," for detailed gRPC tracing"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"regional-considerations",children:"Regional Considerations"}),"\n",(0,s.jsx)(n.p,{children:"Google Cloud Secret Manager automatically replicates secrets globally by default. For specific regional requirements, you can configure replication policies when creating secrets manually or extend the provider to support custom replication settings."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var r=i(6540);const s={},o=r.createContext(s);function t(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);