@page "/settings"
@using Fig.Web.Models
@using Fig.Web.Models.Setting
@using Fig.Contracts.Authentication
@using Fig.Contracts.Health
@using Fig.Web.ExtensionMethods

<div class="container-fluid p-0">
    <div class="row g-3">
        <div class="col" style="flex: 0 0 @(_leftPanelWidth)%; max-width: @(_leftPanelWidth)%; transition: none;">
            <div style="position: relative;">
                    <span style="
                        position: absolute;
                        top: 18px;
                        right: 20px;
                        z-index: 10;
                        display: flex;
                        align-items: center;
                        padding: 2px 10px;">
                        @if (AggregateHealthStatus == FigHealthStatus.Healthy)
                        {
                            <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: green"
                                        MouseEnter="@(args => ShowTooltip(args, "All clients healthy"))"/>
                        }
                        else if (AggregateHealthStatus == FigHealthStatus.Unhealthy)
                        {
                            <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: red"
                                        MouseEnter="@(args => ShowTooltip(args, "At least one client unhealthy"))"/>
                        }
                        else if (AggregateHealthStatus == FigHealthStatus.Degraded)
                        {
                            <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: orange"
                                        MouseEnter="@(args => ShowTooltip(args, "At least one client degraded"))"/>
                        }
                        else
                        {
                            <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: grey"
                                        MouseEnter="@(args => ShowTooltip(args, "Health unknown"))"/>
                        }
                        @if (!string.IsNullOrWhiteSpace(_listFilterText))
                        {
                            <span class="filter-count-overlay">
                                @VisibleSettingClients.Count of @GetTotalClientsCount()
                            </span>
                        }
                    </span>
                <RadzenListBox AllowFiltering="true" @bind-Value=@SelectedSettingClient
                               FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                               TValue="SettingClientConfigurationModel" Data=@VisibleSettingClients
                               TextProperty="DisplayName"
                               LoadData=@OnFilter
                               Class="w-100 p-3" style="height: 100%; min-height: calc(100vh - 120px)">
                    <Template>
                        <div class="d-flex client-row @(GetClientRowClasses(((SettingClientConfigurationModel)context)))" 
                             style="@GetItemIndent(((SettingClientConfigurationModel)context))">
                            <!-- Dynamic checkbox slot with hover zone -->
                            <div class="checkbox-container @(GetCheckboxContainerClasses(((SettingClientConfigurationModel)context)))"
                                 @onmouseenter="() => SetClientHovered(((SettingClientConfigurationModel)context), true)"
                                 @onmouseleave="() => SetClientHovered(((SettingClientConfigurationModel)context), false)">
                                @if (ShouldShowCheckbox(((SettingClientConfigurationModel)context)))
                                {
                                    <RadzenCheckBox Value="@GetCheckboxValue(((SettingClientConfigurationModel)context))"
                                                    ValueChanged="@((bool isChecked) => HandleCheckboxChange(((SettingClientConfigurationModel)context), isChecked))"
                                                    Class="client-checkbox"/>
                                }
                                <!-- Extended hover zone -->
                                <div class="checkbox-extended-hover-zone"></div>
                            </div>
                            <!-- Content container that slides -->
                            <div class="client-content @(GetClientContentClasses(((SettingClientConfigurationModel)context)))">
                                <!-- Expand/collapse slot (fixed width) -->
                                <div class="p-1 d-flex align-items-center" style="width: 24px; justify-content: center;">
                                @if (!((SettingClientConfigurationModel)context).IsGroup &&
                                     ((SettingClientConfigurationModel)context).Instance == null &&
                                     GetInstanceCount(((SettingClientConfigurationModel)context)) > 0)
                                {
                                    <div @onclick="@(() => ToggleClientExpand(((SettingClientConfigurationModel)context).Name))" style="cursor: pointer;">
                                        <RadzenIcon Icon="@(IsClientExpanded(((SettingClientConfigurationModel)context).Name) ? "expand_more" : "chevron_right")"
                                                    Size="1rem" Style="color: var(--rz-text-color);"
                                                    MouseEnter="@(args => ShowTooltip(args, IsClientExpanded(((SettingClientConfigurationModel)context).Name) ? "Collapse instances" : "Expand instances"))" />
                                    </div>
                                }
                                else
                                {
                                    <div style="width: 16px;"></div>
                                }
                            </div>
                            <div class="p-1">
                                @if (!((SettingClientConfigurationModel)context).IsGroup)
                                {
                                    @if (((SettingClientConfigurationModel)context).CurrentRunSessions == 0)
                                    {
                                        <RadzenBadge
                                            Text="@GetRunSessionsBadgeText(((SettingClientConfigurationModel)context))"
                                            IsPill="true" BadgeStyle="BadgeStyle.Primary"
                                            MouseEnter="@(args => ShowTooltip(args, GetRunSessionsTooltipText(((SettingClientConfigurationModel)context))))"/>
                                    }
                                    else if (((SettingClientConfigurationModel)context).AllRunSessionsRunningLatest)
                                    {
                                        <RadzenBadge
                                            Text="@GetRunSessionsBadgeText(((SettingClientConfigurationModel)context))"
                                            IsPill="true" BadgeStyle="BadgeStyle.Success"
                                            MouseEnter="@(args => ShowTooltip(args, GetRunSessionsTooltipText(((SettingClientConfigurationModel)context))))"/>
                                    }
                                    else
                                    {
                                        <RadzenBadge
                                            Text="@GetRunSessionsBadgeText(((SettingClientConfigurationModel)context))"
                                            IsPill="true" BadgeStyle="BadgeStyle.Light"
                                            MouseEnter="@(args => ShowTooltip(args, GetRunSessionsTooltipText(((SettingClientConfigurationModel)context))))"/>
                                    }
                                }
                            </div>
                            <div class="flex-grow-1 p-1 client-item-text"
                                 data-test-id="@(((SettingClientConfigurationModel)context).DisplayName)">
                                @if (((SettingClientConfigurationModel)context).IsGroup ||
                                     ((SettingClientConfigurationModel)context).Instance == null)
                                {
                                    <div class="client-name">@(((SettingClientConfigurationModel)context).DisplayName)</div>
                                }
                                else
                                {
                                    <div class="client-name">@(((SettingClientConfigurationModel)context).Name)</div>
                                    <div class="instance-name"><strong>@(((SettingClientConfigurationModel)context).Instance)</strong></div>
                                }
                            </div>
                            <div class="p-1">
                                @if (((SettingClientConfigurationModel)context).DirtySettingCount > 0)
                                {
                                    <RadzenBadge
                                        Text="@(((SettingClientConfigurationModel)context).DirtySettingCount.ToString())"
                                        IsPill="true" BadgeStyle="BadgeStyle.Info"
                                        MouseEnter="@(args => ShowTooltip(args, $"{((SettingClientConfigurationModel)context).DirtySettingCount.ToString()} unsaved setting change(s)"))"/>
                                }
                            </div>
                            <div class="p-1">
                                @if (((SettingClientConfigurationModel)context).CurrentHealth == FigHealthStatus.Healthy)
                                {
                                    <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: green"
                                                MouseEnter="@(args => ShowTooltip(args, $"All instances are healthy"))"/>
                                }
                                else if (((SettingClientConfigurationModel)context).CurrentHealth == FigHealthStatus.Unhealthy)
                                {
                                    <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: red"
                                                MouseEnter="@(args => ShowTooltip(args, $"Some instances are unhealthy"))"/>
                                }
                                else if (((SettingClientConfigurationModel)context).CurrentHealth == FigHealthStatus.Degraded)
                                {
                                    <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: orange"
                                                MouseEnter="@(args => ShowTooltip(args, $"Some instances are degraded"))"/>
                                }
                                else if (((SettingClientConfigurationModel)context).CurrentRunSessions > 0)
                                {
                                    <RadzenIcon Icon="ecg_heart" Size="1.5rem" Style="color: grey"
                                                MouseEnter="@(args => ShowTooltip(args, $"Health Unknown"))"/>
                                }
                            </div>
                            
                        </div>
                    </div>

                    </Template>
                </RadzenListBox>
            </div>

        </div>

        <!-- Resize handle -->
        <div class="resize-handle" @ref="_resizeHandleRef"
             @onmousedown="OnResizeStart"
             @onmousedown:preventDefault="true"
             style="flex: 0 0 1px; cursor: col-resize; background: transparent; position: relative; z-index: 10;">
            <div class="resize-handle-indicator"></div>
        </div>

        <div class="col" style="flex: 1 1 auto; min-width: 0; transition: none;">
            <!-- Toolbar reference point for calculating floating position -->
            <div @ref="_toolbarRef" class="toolbar-reference"></div>
            
            <!-- Floating toolbar container -->
            <div class="@GetToolbarCssClass()" style="@GetToolbarStyle()">
                <div class="d-flex justify-content-end align-items-center toolbar-content">
                    <div class="p-1 flex-fill" style="margin-right: 5px; position: relative;">
                        <RadzenTextBox @ref="_filterTextBox" Placeholder="Filter" class="w-100" @bind-Value="_settingFilter" @oninput=@OnFilterInput Disabled=@IsToolbarFilterDisabled style="padding-right: 80px;"
                                      @onfocus="ShowFilterTooltip" @onblur="HideFilterTooltip"/>
                        @if (!string.IsNullOrWhiteSpace(_settingFilter) || _selectedCategory != null)
                        {
                            <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 8px;">
                                <span style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); font-size: 0.85em; width:50px; color: #666;">
                                    @GetVisibleSettingsCount() of @GetTotalSettingsCount()
                                </span>
                                <RadzenIcon Icon="close" 
                                            Style="cursor: pointer; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.6;" 
                                            @onclick="@ClearSettingFilter" />
                            </div>
                        }
                    </div>
                    <div class="p-1" style="margin-right: 5px; min-width: 180px; width: 400px;">
                        <RadzenDropDown @bind-Value="_selectedCategory"
                                       Data="@_availableCategories"
                                       TextProperty="Name"
                                       Placeholder="Filter by category..."
                                       AllowFiltering="true"
                                       AllowClear="true"
                                       Change="@OnCategoryFilterChanged"
                                       Disabled="@IsToolbarFilterDisabled"
                                       Style="width: 100%;">
                            <Template Context="category">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: @category.Color;"></span>
                                    <span>@category.Name</span>
                                </div>
                            </Template>
                        </RadzenDropDown>
                    </div>
                    @if (SelectedSettingClient?.Instance != null)
                    {
                        <div class="d-flex align-items-center">
                            <label>Different from Base</label>
                        </div>
                        <div class="p-1 d-flex align-items-center">
                            <RadzenSwitch Change=@(ShowDifferentOnlyChanged) Name="ToggleModified"/>
                        </div>
                    }
                    <div class="d-flex align-items-center">
                        <label>Advanced</label>
                    </div>
                    <div class="p-1 d-flex align-items-center">
                        <RadzenSwitch @bind-Value="@_showAdvanced" Change=@(ShowAdvancedChanged) Name="ToggleAdvanced" Disabled=@IsToolbarAdvancedDisabled/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(_ => SelectedSettingClient?.CollapseAll())
                                      Icon="unfold_less" Disabled=@IsToolbarExpandCollapseDisabled ButtonStyle="ButtonStyle.Warning"
                                      MouseEnter="@(args => ShowTooltip(args, "Collapse All"))"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(_ => SelectedSettingClient?.ExpandAll())
                                      Icon="unfold_more" Disabled=@IsToolbarExpandCollapseDisabled ButtonStyle="ButtonStyle.Warning"
                                      MouseEnter="@(args => ShowTooltip(args, "Expand All"))"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton
                            Click=@(_ => ShowDescription(SelectedSettingClient?.Name, SelectedSettingClient?.Description))
                            Icon="description" Disabled=@IsToolbarDescriptionDisabled ButtonStyle="ButtonStyle.Warning"
                            MouseEnter="@(args => ShowTooltip(args, "Client description"))"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(async _ => await ShowTimelineDialog()) Icon="timeline" 
                                      Disabled=@IsTimelineDisabled ButtonStyle="ButtonStyle.Warning"
                                      MouseEnter="@(args => ShowTooltip(args, "Show setting changes timeline"))"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(async _ => await OnSave()) Text="@GetSaveButtonText()" Icon="save" BusyText="Saving..."
                                      IsBusy=@_isSaveInProgress Disabled=@IsSaveDisabled ButtonStyle="ButtonStyle.Success"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(async _ => await OnSaveAll()) Text="@GetSaveAllButtonText()" Icon="backup_table"
                                      BusyText="Saving..."
                                      IsBusy=@_isSaveAllInProgress Disabled=@IsSaveAllDisabled
                                      ButtonStyle="ButtonStyle.Success"/>
                    </div>
                    <div class="p-1">
                        <RadzenButton Click=@(async _ => await OnAddInstance()) Icon="add_circle_outline"
                                      Disabled=@IsInstanceDisabled ButtonStyle="ButtonStyle.Secondary"
                                      MouseEnter="@(args => ShowTooltip(args, "Create Instance"))"/>
                    </div>
                    @if (AccountService.AuthenticatedUser?.Role == Role.Administrator)
                    {
                        <div class="p-1">
                            <RadzenButton Click=@(_ => OnChangeSecret()) Icon="change_circle"
                                          Disabled=@IsClientSecretChangeDisabled ButtonStyle="ButtonStyle.Danger"
                                          MouseEnter="@(args => ShowTooltip(args, "Change client secret"))"/>
                        </div>
                        <div class="p-1">
                            <RadzenButton Click=@(_ => OnDelete()) Icon="delete" BusyText="Deleting..."
                                          IsBusy=@_isDeleteInProgress Disabled=@IsDeleteDisabled
                                          ButtonStyle="ButtonStyle.Danger"
                                          MouseEnter="@(args => ShowTooltip(args, "Delete Client"))"/>
                        </div>
                    }
                </div>
            </div>

            @if (SelectedSettingClient != null && !HasMultipleClientsSelected)
            {
                if (!SelectedSettingClient.IsGroup)
                {
                    <div class="d-flex">
                        <div class="p-1">
                            @if (SelectedSettingClient.CurrentRunSessions == 0)
                            {
                                <RadzenBadge Text="@(SelectedSettingClient.CurrentRunSessions.ToString())"
                                             IsPill="true" BadgeStyle="BadgeStyle.Primary"/>
                            }
                            else if (SelectedSettingClient.AllRunSessionsRunningLatest)

                            {
                                <RadzenBadge Text="@(SelectedSettingClient.CurrentRunSessions.ToString())"
                                             IsPill="true" BadgeStyle="BadgeStyle.Success"/>
                            }
                            else
                            {
                                <RadzenBadge Text="@(SelectedSettingClient.CurrentRunSessions.ToString())"
                                             IsPill="true" BadgeStyle="BadgeStyle.Light"/>
                            }
                        </div>
                        <div class="p-1">
                            online
                            client(s). @(SelectedSettingClient.AllRunSessionsRunningLatest ? "All running latest settings." : "Running outdated settings.") @(SelectedSettingClient?.Settings.Count) setting(s)
                            (@(SelectedSettingClient?.Settings.Count(a => a.Advanced)) advanced).
                        </div>
                        @if (SelectedSettingClient?.DirtySettingCount > 0)
                        {
                            <div class="p-1">
                                <RadzenBadge Text="@(SelectedSettingClient?.DirtySettingCount.ToString())"
                                             IsPill="true" BadgeStyle="BadgeStyle.Info"/>
                            </div>
                            <div class="p-1">
                                unsaved change(s).
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="d-flex">
                        <div class="p-1">
                            Setting Group. @(SelectedSettingClient?.Settings.Count) setting(s)
                            (@(SelectedSettingClient?.Settings.Count(a => a.Advanced)) advanced).
                        </div>
                        @if (SelectedSettingClient?.DirtySettingCount > 0)
                        {
                            <div class="p-1">
                                <RadzenBadge Text="@(SelectedSettingClient?.DirtySettingCount.ToString())"
                                             IsPill="true" BadgeStyle="BadgeStyle.Success"/>
                            </div>
                            <div class="p-1">
                                unsaved change(s).
                            </div>
                        }
                    </div>
                }

                @if (SelectedSettingClient is not null)
                {
                    var orderedSettings = SelectedSettingClient.Settings.OrderBy(a => a.DisplayOrder).ToList();
                    
                    for (int i = 0; i < orderedSettings.Count; i++)
                    {
                        var setting = orderedSettings[i];
                        var settingIndex = i;
                        
                        @if (setting.Heading != null)
                        {
                            var referencedSettings = GetSettingsAfterHeading(orderedSettings, settingIndex);
                            <HeadingCard Heading="@setting.Heading"
                                         ClientName="@SelectedSettingClient.Name"
                                         Instance="@(SelectedSettingClient.Instance ?? string.Empty)"
                                         SettingName="@setting.Name"
                                         HeadingType="@HeadingType.Setting"
                                         ShowAdvanced="@_showAdvanced"
                                         IsCollapsed="@IsCollapsedState(orderedSettings)"
                                         ReferencedSettings="@referencedSettings" />
                        }
                        <SettingCard Setting="@setting"/>
                    }

                    @if (SelectedSettingClient.CustomActions.Any())
                    {
                        <HeadingCard Heading="@(HeadingModel.CreateForCustomAction())"
                                     ClientName="@SelectedSettingClient.Name"
                                     Instance="@(SelectedSettingClient.Instance ?? string.Empty)"
                                     SettingName="custom-actions"
                                     HeadingType="@HeadingType.CustomAction"
                                     ShowAdvanced="@_showAdvanced"
                                     IsCollapsed="@false"
                                     ReferencedSettings="@(new List<ISetting>())" />
                    }
                    
                    @foreach (var customAction in SelectedSettingClient.CustomActions.OrderBy(a => a.Name))
                    {
                        <CustomActionCard CustomAction="@customAction" ClientName="@SelectedSettingClient.Name"/>
                    }
                }
            }
            else if (HasMultipleClientsSelected)
            {
                <div class="multi-select-card">
                    <div class="multi-select-content">
                        <div class="multi-select-icon">
                            <RadzenIcon Icon="checklist" Style="font-size: 3rem; color: var(--rz-primary); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.15));" />
                        </div>
                        <div class="multi-select-title">
                            @_selectedClients.Count clients selected
                        </div>
                        <div class="multi-select-subtitle">
                            Use the toolbar buttons above to perform actions on all selected clients.
                        </div>
                        <div class="multi-select-summary">
                            @{
                                var clientsWithChanges = _selectedClients.Count(c => c.IsDirty);
                                var totalChanges = _selectedClients.Sum(c => c.DirtySettingCount);
                            }
                            @if (clientsWithChanges > 0)
                            {
                                <div class="summary-chip changes">
                                    <RadzenIcon Icon="edit" Style="font-size: 1rem; margin-right: 6px;" />
                                    @clientsWithChanges client(s) with @totalChanges unsaved change(s)
                                </div>
                            }
                            else
                            {
                                <div class="summary-chip no-changes">
                                    <RadzenIcon Icon="check_circle" Style="font-size: 1rem; margin-right: 6px;" />
                                    No unsaved changes
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else if (_isLoadingSettings)
            {
                <div
                    style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center;">
                    <div>
                        <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Determinate"
                                                   @bind-Value="@_loadProgress" Size="ProgressBarCircularSize.Large"/>
                    </div>
                    <div>
                        <p>@_loadingMessage</p>
                    </div>
                </div>
            }
            else
            {
                var noClients = FilteredSettingClients is null || !FilteredSettingClients.Any();
                <div class="empty-state">
                    <div class="empty-card">
                        <div class="empty-icon">
                            @if (noClients)
                            {
                                <RadzenIcon Icon="hub" Style="font-size: 3rem; color: var(--rz-primary); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.15));" />
                            }
                            else
                            {
                                <RadzenIcon Icon="touch_app" Style="font-size: 3rem; color: var(--rz-primary); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.15));" />
                            }
                        </div>
                        <div class="empty-title">
                            @(noClients ? "No setting clients yet" : "Select a client to get started")
                        </div>
                        <div class="empty-subtitle">
                            @(noClients
                                ? "There are no clients loaded. Start a client app connected to Fig or check API connectivity."
                                : "Pick a client from the list on the left or use the filter to quickly find one.")
                        </div>
                        @if (!noClients)
                        {
                            <div class="empty-hints">
                                <div class="hint-chip">
                                    <RadzenIcon Icon="search" Style="font-size: 1rem; margin-right: 6px;" />
                                    Use the filter box to narrow results
                                </div>
                                <div class="hint-chip">
                                    <RadzenIcon Icon="favorite" Style="font-size: 1rem; margin-right: 6px;" />
                                    Health indicator shows overall status
                                </div>
                                <div class="hint-chip">
                                    <RadzenIcon Icon="description" Style="font-size: 1rem; margin-right: 6px;" />
                                    View client description from the toolbar
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .glow-highlight {
        box-shadow: 0 0 0 4px yellow, 0 0 16px 8px yellow;
        transition: box-shadow 0.3s ease;
        z-index: 100;
    }

    /* Resize handle styles */
    .resize-handle {
        display: flex;
        align-items: stretch;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        padding: 0 8px; /* Expand hover zone on both sides */
        margin: 0 -8px; /* Negative margin to compensate and keep visual gap minimal */
    }

    .resize-handle:hover .resize-handle-indicator,
    .resize-handle.dragging .resize-handle-indicator {
        opacity: 1;
    }

    .resize-handle-indicator {
        width: 1px;
        background: linear-gradient(to bottom, rgba(99, 102, 241, 0.2), rgba(16, 185, 129, 0.2));
        border-radius: 0.5px;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .resize-handle.dragging .resize-handle-indicator {
        width: 2px;
        background: linear-gradient(to bottom, rgba(99, 102, 241, 0.4), rgba(16, 185, 129, 0.4));
        box-shadow: 0 0 4px rgba(99, 102, 241, 0.3);
    }

    /* Disable transitions during drag */
    .resizing * {
        transition: none !important;
    }

    .toolbar-reference {
        height: 0;
        width: 100%;
    }

    .toolbar-container {
        transition: all 0.3s ease;
        width: 100%;
        z-index: 1000;
    }

    .toolbar-fixed {
        position: relative;
        background: transparent;
    }

    .toolbar-floating {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(33, 37, 41, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease-out;
        color-scheme: dark;
    }

    @@keyframes slideDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .toolbar-content {
        padding: 10px 15px;
        margin: 0 auto;
        max-width: 100%;
        background: transparent;
    }

    /* Filter count overlay */
    .filter-count-overlay {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        right: 60px;
        z-index: 10;
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
        padding: 4px 12px;
        background: rgba(99, 102, 241, 0.25);
        border: 1px solid rgba(99, 102, 241, 0.5);
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #a5b4fc;
        pointer-events: none;
    }

    /* Ensure floating toolbar maintains proper spacing */
    .toolbar-floating + * {
        margin-top: 60px; /* toolbar height */
    }
    
    /* Left list item text layout */
    .client-item-text .client-name {
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.1;
    }
    .client-item-text .instance-name {
        margin-top: 2px;
        font-size: 0.8rem;
        font-weight: 700;
        opacity: 0.85;
    }

    /* Dynamic client row layout */
    .client-row {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        align-items: center;
    }

    /* Dynamic checkbox container */
    .checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 2;
    }

    .checkbox-container.hidden {
        width: 0;
        opacity: 0;
        transform: translateX(-100%);
    }

    .checkbox-container.visible {
        width: 32px;
        opacity: 1;
        transform: translateX(0);
    }

    .checkbox-container.selected {
        width: 32px;
        opacity: 1;
        transform: translateX(0);
    }

    /* Extended hover zone that covers the trigger area */
    .checkbox-extended-hover-zone {
        position: absolute;
        right: -10px; /* Start from the right edge of the checkbox container */
        top: 0;
        bottom: 0;
        width: 80px; /* Extends right to cover the trigger area */
        z-index: 1;
        pointer-events: auto;
    }

    /* Only show the extended zone when checkbox container is hidden */
    .checkbox-container.visible .checkbox-extended-hover-zone,
    .checkbox-container.selected .checkbox-extended-hover-zone {
        display: none;
    }

    .checkbox-container.hidden .checkbox-extended-hover-zone {
        display: block;
    }

    /* Client content sliding container */
    .client-content {
        display: flex;
        flex: 1;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 1;
    }

    .client-content.normal {
        margin-left: 0;
    }

    .client-content.hovered {
        margin-left: 32px;
    }

    .client-content.selected {
        margin-left: 32px;
    }

    /* Checkbox styling */
    .client-checkbox {
        transition: all 0.2s ease;
        transform: scale(0.9);
    }
    
    .client-checkbox:hover {
        transform: scale(1.0);
    }

    /* Multi-select card styles */
    .multi-select-card {
        min-height: calc(100vh - 160px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
    }

    .multi-select-content {
        max-width: 460px;
        width: 100%;
        background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(16,185,129,0.12));
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 10px 28px rgba(0,0,0,0.35);
        text-align: center;
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        animation: floaty 6s ease-in-out infinite;
    }

    .multi-select-icon {
        height: 80px;
        width: 80px;
        margin: 0 auto 14px auto;
        display: grid;
        place-items: center;
        border-radius: 20px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.18);
        box-shadow: inset 0 0 0 2px rgba(0,0,0,0.2), 0 8px 18px rgba(0,0,0,0.45);
    }

    .multi-select-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .multi-select-subtitle {
        font-size: 0.95rem;
        opacity: 0.85;
        margin-bottom: 20px;
    }

    .multi-select-summary {
        margin-bottom: 20px;
    }

    .summary-chip {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0 4px;
    }

    .summary-chip.changes {
        background: rgba(244, 114, 182, 0.2);
        color: #f472b6;
        border: 1px solid rgba(244, 114, 182, 0.4);
    }

    .summary-chip.no-changes {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .multi-select-hints {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    /* Empty state styles */
    .empty-state {
        min-height: calc(100vh - 160px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
    }

    .empty-card {
        max-width: 860px;
        width: 100%;
        background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(16,185,129,0.12));
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 16px;
        padding: 28px;
        box-shadow: 0 10px 28px rgba(0,0,0,0.35);
        text-align: center;
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        animation: floaty 6s ease-in-out infinite;
    }

    .empty-icon {
        height: 80px;
        width: 80px;
        margin: 0 auto 14px auto;
        display: grid;
        place-items: center;
        border-radius: 20px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.18);
        box-shadow: inset 0 0 0 2px rgba(0,0,0,0.2), 0 8px 18px rgba(0,0,0,0.45);
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .empty-subtitle {
        font-size: 0.95rem;
        opacity: 0.85;
        margin-bottom: 14px;
    }

    .empty-hints {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }

    .hint-chip {
        display: inline-flex;
        align-items: center;
        border: 1px dashed rgba(255,255,255,0.14);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.85rem;
        background: rgba(255,255,255,0.06);
    }

    @@keyframes floaty {
        0% { transform: translateY(0); }
        50% { transform: translateY(-4px); }
        100% { transform: translateY(0); }
    }

    /* Compact client list items - reduce vertical spacing */
    ::deep .rz-listbox-list .rz-listbox-item {
        padding: 0.1rem 0.5rem !important;
    }

    .client-row .p-1 {
        padding: 0.1rem !important;
    }

    .client-item-text {
        padding: 0.1rem !important;
    }

</style>

@code {

    async Task<bool> GetDeleteConfirmation(string confirmationMessage)
    {
        return await DialogService.OpenAsync("Confirm Delete", ds =>
            @<div>
                <p class="mb-4">@confirmationMessage</p>
                <p class="mb-4">Once deleted, clients will no longer be able to get settings</p>
                <p class="mb-4">This action cannot be reversed.</p>
                <div class="row">
                    <div class="col">
                        <RadzenButton Text="No" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Secondary"
                                      Class="mr-1"/>
                        <RadzenButton Text="Yes" Click="() => ds.Close(true)" Class="mr-1" Style="width: 80px;"/>
                    </div>
                </div>
            </div>) ?? false;
    }

    async Task ShowDescription(string? clientName, string? description)
    {
        if (clientName is null || description is null)
            return;

        await DialogService.OpenAsync($"Description for {clientName}", _ =>
                @<div class="description-dialog-content">
                    @((MarkupString)description.ToHtml())
                </div>,
            new DialogOptions
            {
                Height = "90%",
                Width = "90%"
            });
    }

    async Task<bool> GetInstanceName(string clientName)
    {
        var availableInstances = GetAvailableRunningInstances(clientName);
        
        return await DialogService.OpenAsync("Name Instance", ds =>
            @<div>
                <p>Provide a name for the instance for @clientName.</p>
                <p class="mb-2">The name must match the instance provided by the requesting client.</p>
                @if (availableInstances.Any())
                {
                    <div class="row">
                        <div class="col">
                            <p class="mb-2"><strong>Available running instances:</strong></p>
                            <RadzenDropDown @bind-Value="@_instanceName" 
                                           Data="@availableInstances" 
                                           AllowClear="true"
                                           Placeholder="Select a running instance or clear to enter custom name..."
                                           Class="w-100 mb-3"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <p class="mb-2">Or enter a custom instance name:</p>
                            <RadzenTextBox @bind-Value="@_instanceName" 
                                          Placeholder="Enter custom instance name..."
                                          Class="w-100 mb-2"/>
                        </div>
                    </div>
                }
                else
                {
                    <div class="row">
                        <RadzenTextBox @bind-Value="@_instanceName" 
                                      Placeholder="Enter instance name..."
                                      Class="w-100 m-3"/>
                    </div>
                }
                <div class="row">
                    <div class="col">
                        <RadzenButton Text="Create Instance" Click="() => ds.Close(true)" Class="mr-1"/>
                        <RadzenButton Text="Cancel" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Secondary"
                                      Class="mr-1"/>
                    </div>
                </div>
            </div>) ?? false;
    }

    async Task<bool?> AskUserForChangeMessage(List<ChangeModel> changeModels, ChangeDetailsModel changeDetails)
    {
        return await DialogService.OpenAsync<ChangeMessageDialog>(
            $"[{WebSettings.Value.Environment}] Save Changes",
            new Dictionary<string, object>()
            {
                { "ChangeModels", changeModels },
                { "ChangeDetails", changeDetails }
            },
            new DialogOptions()
            {
                Width = "80%",
                Height = "auto",
                CloseDialogOnEsc = true
            });
    }

    async Task PerformSecretChange(string clientName)
    {
        await DialogService.OpenAsync<ClientSecretChange>($"Change client secret for {clientName}",
            new Dictionary<string, object>() { { "ClientName", clientName } },
            new DialogOptions() { Resizable = true, Draggable = true });
    }

    private void ShowTooltip(ElementReference elementReference, string tooltipText)
    {
        var style = "background-color: black";
        TooltipService.Open(elementReference, tooltipText, new TooltipOptions
        {
            Style = style,
            Duration = 6000
        });
    }

    private void ShowFilterTooltip()
    {
        var tooltipText = @"Filter Settings
Applied in conjunction with category and advanced filters.

Property Filters (use prefix:value):
• advanced:true/false - Show advanced settings
• category:<name> - Filter by category name
• classification:<name> - Filter by classification name
• secret:true/false - Show secret settings
• valid:true/false - Show valid/invalid settings
• modified:true/false - Show modified settings

General Search:
Any text without a prefix searches across setting names, descriptions, and values.

Examples:
• advanced:t database
• category:api secret:t
• modified:t valid:f";

        TooltipService.Open(_filterTextBox.Element, tooltipText, new TooltipOptions
        {
            Style = "background-color: #2d3748; white-space: pre-line; max-width: 400px; padding: 12px;",
            Duration = null // Stay open until blur
        });
    }

    private void HideFilterTooltip()
    {
        TooltipService.Close();
    }

    private void OnFilterInput(ChangeEventArgs args)
    {
        HideFilterTooltip();
        _filterTerm.OnNext(args);
    }

    private async Task ShowSearchDialog()
    {
        await DialogService.OpenAsync("", ds =>
            @<div style="height: 100%; display: flex; flex-direction: column;">
                <RadzenAutoComplete
                    @ref="@SearchAutoComplete"
                    Style="width: 100%; height: 100%;"
                    Placeholder="Search settings..."
                    LoadData=@OnLoadData
                    MinLength="1"
                    FilterDelay="300"
                    SelectedItemChanged="OnSelectedSearchItemChanged"
                    PopupStyle="max-height: 400px; width: 100%;"
                    TValue="ISearchableSetting">
                    <Template>
                        <div
                            style="display: grid; grid-template-columns: 56px 1.2fr 1.5fr 2px 0.9fr; align-items: center; min-height: 44px; padding: 2px 0;">
                            <!-- Icon box -->
                            <div
                                style="display: flex; align-items: center; justify-content: center; color: @(context.CategoryColor == "#00000000" ? "white" : context.CategoryColor); border-radius: 14px;">
                                <RadzenIcon Icon="@(context.IconKey)" Style="font-size: 2rem;"/>
                            </div>
                            <!-- Setting name and description -->
                            <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0;">
                                <div
                                    style="font-size: 1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @context.DisplayName
                                </div>
                                <div
                                    style="font-size: 0.6rem; color: #e0e0e0; opacity: 0.85; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @context.TruncatedDescription
                                </div>
                            </div>
                            <!-- Setting value -->
                            <div
                                style="font-size: 0.8rem; color: #b0b0b0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                @context.StringValue
                            </div>
                            <!-- Separator -->
                            <div
                                style="width: 2px; background: #888; height: 36px; margin-right: 15px; border-radius: 2px; justify-self: center;"></div>
                            <!-- Client name and instance -->
                            <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0;">
                                <div
                                    style="font-size: 1rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @context.ParentName
                                </div>
                                <div
                                    style="font-size: 0.6rem; color: #e0e0e0; opacity: 0.85; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @context.ParentInstance
                                </div>
                            </div>
                        </div>
                    </Template>
                </RadzenAutoComplete>
            </div>, new DialogOptions()
        {
            CloseDialogOnOverlayClick = true,
            CloseDialogOnEsc = true,
            ShowClose = false,
            ShowTitle = false,
            Style = "min-height: 10px; width: 70vw; top: 25vh; position: fixed; transform: translateY(0);",
            AutoFocusFirstElement = true
        });
    }



}



